# OpenContrail Configuration Python API

## 1 Architecture

### 1.1 Data Model

Configuration data model [vnc_cfg.xsd](https://github.com/Juniper/contrail-controller/blob/master/src/schema/vnc_cfg.xsd)is defined in XML Schema Definition (XSD) format.

Data model defines all configuration resources and their properties and relations.


### 1.2 REST API and Python API

The REST API is defined for CRUD (Create, Read, Update, Delete) operations to configuration resources.

Python API is the language wrapper of REST API. Python API is generated by [contrail-generateDS](https://github.com/Juniper/contrail-generateDS) from data model XSD.

Python API is installed from package python-contrail to Python library directory, for example, /usr/lib/python2.7/dist-packages/vnc_api on Ubuntu, /usr/lib/python2.7/site-packages/vnc_api on CentOS.


### 1.3 API Server

Configuration API server provides REST API support. Client connects to API server to operate configuration objects by REST API.

API server works in either authentication mode or non-authentication mode. In authentication mode, API server connects to authentication server to authenticate each request. Only requests from authenticated user are accepted. Currently, OpenStack Keystone service is supported as the authentication service. In non-authentication mode, any requests from any user is accepted.

The backend of API server is the Cassandra database for storing all configuration data.


### 1.4 Integration

OpenContrail networking can working alone. Client can connect to API server directly to manipulate configurations. OpenContrail can also be integrated with other orchestration/stack application. In case of the integration with OpenStack, OpenStack Neutron Plugin acts as the client of API server and connect frontend Neutron and backend OpenContrail together. Neutron database is not required. All networking data is stored at single place that is the OpenContrail database.


## 2 Connect to API server

Here is an example.
```
from vnc_api import vnc_api

vnc = vnc_api.VncApi(username = "admin", password = "password",
        tenant_name = "admin", api_server_host = "10.1.1.1",
        auth_host = "10.1.1.2")
```


## 3 Resource

There are multiple options to find out how resources are connected and configured.
* Read vnc_cfg.xsd to see all resources and their properties, links, etc.
* Read resource_common.py and resource_xsd.py to see how to use Python configure resources.
* Run [show-schema](show-schema) that reads vnc_cfg.xsd and show resources, "show-schema list", "show-schema all", "show-schema <resource name>".

Here are some examples.

* IPAM
Create default-domain:demo:ipam-default.
```
tenant = vnc.project_read(fq_name = 'default-domain:demo'.split(':')])
ipam = vnc_api.NetworkIpam(name = 'ipam-default', parent_obj = tenant)
vnc.network_ipam_create(ipam)
```

* Policy
Create default-domain:demo:policy-default to allow all traffic.
```
rule = vnc_api.PolicyRuleType(
        direction = '<>',
        protocol = 'any',
        action_list = vnc_api.ActionListType(simple_action = 'pass'),
        src_addresses = [vnc_api.AddressType(virtual_network = 'any')],
        src_ports = [vnc_api.PortType(start_port = -1, end_port = -1)],
        dst_addresses = [vnc_api.AddressType(virtual_network = 'any')],
        dst_ports = [vnc_api.PortType(start_port = -1, end_port = -1)])
policy = vnc_api.NetworkPolicy(
        name = 'policy-default',
        parent_obj = tenant,
        network_policy_entries = vnc_api.PolicyEntriesType([rule]))
vnc.network_policy_create(policy)
```

* Virtual Network
Create default-domain:demo:red with 192.168.10.0/24.
```
vn = vnc_api.VirtualNetwork(name = 'red', parent_obj = tenant)
ipam = vnc.network_ipam_read(fq_name = 'default-domain:demo:ipam-default'.split(':'))
subnet = vnc_api.subnetType(ip_prefix = '192.168.10.0', ip_prefix_len = 24)
ipam_subnet = vnc_api.IpamSubnetType(subnet = subnet, default_gateway = '192.168.10.1')
vn.set_network_ipam(ref_obj = ipam, ref_data = vnc_api.VnSubnetsType([ipam_subnet]))
vnc.virtual_network_create(vn)
```

Attach policy to virtual network.
```
policy = vnc.network_policy_read(fq_name = 'default-domain:demo:policy-default'.split(':'))
policy_type = vnc_api.VirtualNetworkPolicyType(
        sequence = vnc_api.SequenceType(major = 0, minor = 0))
vn = vnc.virtual_network_read(fq_name = 'default-domain:demo:red'.split(':'))
vn.add_network_policy(ref_obj = policy, ref_data = policy_type)
vnc.virtual_network_update(vn)
```

Set route target for virtual network default-domain:admin:public.
```
vn = vnc.virtual_network_read(fq_name = 'default-domain:admin:public'.split(':'))
route_targets = vnc_api.RouteTargetList(['target:64512:10000'])
vn.set_route_target_list(route_targets)
vnc.virtual_network_update(vn)
```

* Floating IP
Create floating IP pool in virtual network default-domain:admin:public.
```
vn = vnc.virtual_network_read(fq_name = 'default-domain:admin:public'.split(':'))
pool = vnc_api.FloatingIpPool(name = 'public-pool', parent_obj = vn)
vnc.floating_ip_pool_create(pool)

# Add reference to floating IP pool in the tenant who will need to
# allocate floating IP.
tenant = vnc.project_read(fa_name = 'default-domain:demo'.split(':'))
tenant.add_floating_ip_pool(pool)
vnc.project_update(tenant)
```

Allocate floating IP.
```
id = str(uuid.uuid4())
pool = vnc.floating_ip_pool_read(fq_name = 'default-domain:admin:public:public-pool'.split(':'))
fip = vnc_api.FloatingIp(name = id, parent_obj = pool)
fip.uuid = id
vnc.floating_ip_create(fip)
```

Assign floating IP to virtual machine interface.
```
vm = vnc.virtual_machine_read(id = <VM UUID>)

# Get the first interface.
if_id = vm.get_virtual_machine_interfaces()[0]['uuid']
if_obj = vnc.virtual_machine_interface_read(id = if_id)

tenant = vnc.project_read(fq_name = 'default-domain:demo'.split(':'))
fip.add_project(tenant)
fip.add_virtual_machine_interface(if_obj)
vnc.floating_ip_update(fip)
```


### Appendix A Data Model Graph

Data model graph can be generated from vnc_api/gen/vnc_api_schema.py. Some additional package are required. Here is an example.
```
# wget http://pydot.googlecode.com/files/pydot-1.0.28.tar.gz
# pip install pydot-1.0.28.tar.gz
# wget https://pypi.python.org/packages/source/p/pyparsing/pyparsing-2.0.3.tar.gz
# pip install pyparsing-2.0.3.tar.gz
# apt-get install graphviz
# python
>>> import pydot
>>> import vnc_api_schema
>>> graph = vnc_api_schema.generate_schema_graph()
>>> graph.write_png("schema.png")
```


